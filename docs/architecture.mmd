%% Auto Dealership Voice Assistant — System Architecture (Mermaid)
flowchart LR
  subgraph Browser[User Interface]
    UI["Web UI — Mic Hub / Chat Window / Controls"]
    SocketClient[(Socket.IO Client)]
  end

  subgraph Backend[Server]
    SocketServer[(Flask + Flask-SocketIO WebSocket Server)]
    Orchestrator[AgentOrchestrator\n(State, Conversation History, Booking Details)]
    ConversationalAgent[ConversationalAgent\n(intent detection, response gen)]
    ConversationalLLM[(OpenAI LLM)]
    KnowledgeAgent[KnowledgeAgent]
    BookingAgent[BookingAgent]
    SpeechService[SpeechService\n(Azure STT / TTS)]
    KnowledgeService[KnowledgeService\n(knowledge_base.json)]
    BookingService[BookingService\n(SQLite bookings.db)]
    Logger[Logging\n(logs/YYYY-MM-DD.log)]
  end

  %% Client → Server
  UI -->|"start_voice / send_message / request_greeting"| SocketClient
  SocketClient -->|WebSocket events| SocketServer

  %% Server routing
  SocketServer -->|emit to| Orchestrator
  Orchestrator -->|intent detection / parse| ConversationalAgent
  ConversationalAgent -->|call LLM| ConversationalLLM

  %% Knowledge & Booking flows
  Orchestrator -->|query / recommend| KnowledgeAgent
  KnowledgeAgent -->|read| KnowledgeService

  Orchestrator -->|booking flow / validate| BookingAgent
  BookingAgent -->|DB operations| BookingService

  %% Speech flows
  SocketServer -->|requests microphone capture| SpeechService
  SpeechService -->|STT → text| Orchestrator
  Orchestrator -->|TTS audio bytes| SpeechService
  SpeechService -->|audio bytes| SocketServer
  SocketServer -->|emit assistant_response (response, audio hex)| SocketClient
  SocketClient -->|play audio blob| UI

  %% Cross-cutting
  Orchestrator -->|write logs| Logger
  SocketServer -->|connection logs| Logger
  KnowledgeService -->|reads| KB[(data/knowledge_base.json)]
  BookingService -->|reads/writes| DB[(data/bookings.db)]

  %% Styling hints
  classDef backend fill:#f3f4f6,stroke:#333,stroke-width:1px
  class Backend backend
